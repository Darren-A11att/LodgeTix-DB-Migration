=== ENHANCED PAYMENT SYNC LOG ===
Started at: 2025-08-17T13:31:48.090Z
Processing Square with orders/customers and contacts

âœ“ Supabase client initialized
âœ“ Square provider initialized (REQUIRED)
âœ“ DA-LODGETIX initialized
âœ“ WS-LODGETIX initialized
âœ“ WS-LODGETICKETS initialized

Initialized 4 payment provider(s)

=== STARTING ENHANCED PAYMENT SYNC ===
Processing workflow:
1. Import payment to import_payments (with field transformation)
2. Fetch order/customer for Square payments
3. Find registration in Supabase
4. Update with charge ID for Stripe
5. Import to import_registrations (with field transformation)
6. Import attendees to import_attendees
7. Import tickets to import_tickets
8. Import contacts to import_contacts with deduplication
9. Process booking contact as customer with registration metadata
9. Selective sync to production collections based on field comparison

âœ“ Connected to MongoDB:
  Cluster: LodgeTix-migration-test-1
  Database: lodgetix
  URI: mongodb+srv:****@lodgetix-migration-test.wydwfu6.mongodb.net/lodgetix?retryWrites=true&w=majority&appName=LodgeTix-migration-test-1

â”â”â” Processing Square â”â”â”

Fetching ALL historical Square payments (one at a time)...
  Fetched payment 1 (cursor: none)

ğŸ“ Processing Square payment: 5WZURjeHRtZKVpza9ECnKKz2R6cZY
  âœ… Importing completed payment - status: COMPLETED
  ğŸ”„ Payment has been updated - cleaning up and reprocessing
  ğŸ§¹ Checking for stale error_payments records for payment: 5WZURjeHRtZKVpza9ECnKKz2R6cZY
  ğŸ›’ Fetching order: jInUk4vuEf5EkHjI18nbjnKF54LZY
    âœ“ Order fetched
  ğŸ‘¤ Fetching customer: QZXPY8QN30GXA89KB6TT9B2J54
    âœ“ Customer fetched
  âœ“ Imported to import_payments with field transformation
  âœ“ Found registration: 232d7ba5-0795-41b8-9532-1747580c5693
  âœ“ Updated import_payments with registrationId: 232d7ba5-0795-41b8-9532-1747580c5693
  âœ“ Imported FULL registration to import_registrations with field transformation
  â¸ï¸ Production sync deferred to selective sync phase (eligible for production sync)
  ğŸ“ Processing booking contact as customer
    Customer data created: Lesley  Hicks
    âœ“ Updated existing customer: Lesley  Hicks
    âœ“ Updated registration with customer ObjectId
    Extracting 2 attendees from registration_data
  âœ“ Found 2 attendee(s)
    Extracting 4 tickets from registration_data.selectedTickets
    ğŸ“ Using event_ticket_id for eventTicketId: d586ecc1-e410-4ef3-a59c-4a53a866bc33
    ğŸ” Looking up eventTicket: d586ecc1-e410-4ef3-a59c-4a53a866bc33
    âœ… Found eventTicket: Meet & Greet Cocktail Party (price: 70)
    ğŸ“ Using event_ticket_id for eventTicketId: bce41292-3662-44a7-85da-eeb1a1e89d8a
    ğŸ” Looking up eventTicket: bce41292-3662-44a7-85da-eeb1a1e89d8a
    âœ… Found eventTicket: Farewell Cruise Luncheon (price: 75)
    ğŸ“ Using event_ticket_id for eventTicketId: d586ecc1-e410-4ef3-a59c-4a53a866bc33
    ğŸ” Looking up eventTicket: d586ecc1-e410-4ef3-a59c-4a53a866bc33
    âœ… Found eventTicket: Meet & Greet Cocktail Party (price: 70)
    ğŸ“ Using event_ticket_id for eventTicketId: bce41292-3662-44a7-85da-eeb1a1e89d8a
    ğŸ” Looking up eventTicket: bce41292-3662-44a7-85da-eeb1a1e89d8a
    âœ… Found eventTicket: Farewell Cruise Luncheon (price: 75)
    ğŸ“¦ Returning 4 processed tickets from registration_data
  âœ“ Found 4 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: import_232d7ba5-0795-41b8-9532-1747580c5693_ticket_0 (Meet & Greet Cocktail Party, qty: 1)
      ğŸ”„ Updated ticket document
    ğŸ’¾ Saving ticket to import_tickets: import_232d7ba5-0795-41b8-9532-1747580c5693_ticket_1 (Farewell Cruise Luncheon, qty: 1)
      ğŸ”„ Updated ticket document
    ğŸ’¾ Saving ticket to import_tickets: import_232d7ba5-0795-41b8-9532-1747580c5693_ticket_2 (Meet & Greet Cocktail Party, qty: 1)
      ğŸ”„ Updated ticket document
    ğŸ’¾ Saving ticket to import_tickets: import_232d7ba5-0795-41b8-9532-1747580c5693_ticket_3 (Farewell Cruise Luncheon, qty: 1)
      ğŸ”„ Updated ticket document
    âœ“ Processed contact: Lesley Norman Hicks
    âœ“ Processed contact: Narelle Hicks
  âœ… Completed processing Square payment 5WZURjeHRtZKVpza9ECnKKz2R6cZY (production eligible)
  Got cursor for next payment
  Fetched payment 2 (cursor: provided)

ğŸ“ Processing Square payment: 5GXVymBC3x18occbL5IXfi34knaZY
  âœ… Importing completed payment - status: COMPLETED
  ğŸ”„ Payment has been updated - cleaning up and reprocessing
  ğŸ§¹ Checking for stale error_payments records for payment: 5GXVymBC3x18occbL5IXfi34knaZY
  ğŸ›’ Fetching order: J56sPyUq53BMVGNcSjNqJZ2blEXZY
    âœ“ Order fetched
  ğŸ‘¤ Fetching customer: XVP1HKZQN7ANCMSMPRDN4GCJYC
    âœ“ Customer fetched
  âœ“ Imported to import_payments with field transformation
