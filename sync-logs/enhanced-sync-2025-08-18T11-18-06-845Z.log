=== ENHANCED PAYMENT SYNC LOG ===
Started at: 2025-08-18T11:18:06.846Z
Processing Square with orders/customers and contacts

âœ“ Supabase client initialized
âœ“ Square provider initialized (REQUIRED)
âœ“ DA-LODGETIX initialized
âœ“ WS-LODGETIX initialized
âœ“ WS-LODGETICKETS initialized

Initialized 4 payment provider(s)
âœ“ Connected to MongoDB:
  Cluster: LodgeTix-migration-test-1
  Database: lodgetix
  URI: mongodb+srv:****@lodgetix-migration-test.wydwfu6.mongodb.net/lodgetix?retryWrites=true&w=majority&appName=LodgeTix-migration-test-1

=== STARTING ENHANCED PAYMENT SYNC ===
Processing workflow:
1. Import payment to import_payments (with field transformation)
2. Fetch order/customer for Square payments
3. Find registration in Supabase
4. Update with charge ID for Stripe
5. Import to import_registrations (with field transformation)
6. Import attendees to import_attendees
7. Import tickets to import_tickets
8. Import contacts to import_contacts with deduplication
9. Process booking contact as customer with registration metadata
9. Selective sync to production collections based on field comparison


â”â”â” Processing Square â”â”â”

Fetching ALL historical Square payments (one at a time)...
  Fetched payment 1 (cursor: none)

ğŸ“ Processing Square payment: F6oCqaqnzPwfTGdhPYIZIBucz3HZY
  âœ… Importing completed payment - status: COMPLETED
  ğŸ›’ Fetching order: 57xju4uTh2YNvMU58pYCiuvR8U6YY
    âœ“ Order fetched
  ğŸ‘¤ Fetching customer: 363XXYEZGMMWF1V301DE3F76RC
    âœ“ Customer fetched
  âœ“ Imported to import_payments with field transformation
  âœ“ Found registration: 2f4c440f-542c-4608-9974-186aef3eb8a1
  âœ“ Updated import_payments with registrationId: 2f4c440f-542c-4608-9974-186aef3eb8a1
  âœ“ Imported FULL registration to import_registrations with field transformation
  ğŸ“ Processing booking contact as customer
    Customer data created: Robert Drake
    âœ“ Created new customer: Robert Drake
    âœ“ Updated registration with customer reference: 3f7d99a3-e9fe-4b05-8523-f59c223d14c6
  âœ“ Found customer data for ticket ownership: Robert Drake
    Extracting 2 attendees from registration_data
  âœ“ Found 2 attendee(s)
    Extracting 4 tickets from registration_data.selectedTickets
    Total tickets after expansion: 4
    ğŸ“ Using event_ticket_id for eventTicketId: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    ğŸ” Looking up eventTicket: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    âœ… Found eventTicket: Grand Proclamation Ceremony (price: 20)
    ğŸ“ Using event_ticket_id for eventTicketId: be94ef03-6647-48d5-97ea-f98c862e30e6
    ğŸ” Looking up eventTicket: be94ef03-6647-48d5-97ea-f98c862e30e6
    âœ… Found eventTicket: Quarterly Communication (price: 0)
    ğŸ“ Using event_ticket_id for eventTicketId: b8a1ef1f-5f53-4544-af7b-901756b9ba7d
    ğŸ” Looking up eventTicket: b8a1ef1f-5f53-4544-af7b-901756b9ba7d
    âœ… Found eventTicket: Existing Banquet Ticket bought by Lodge (price: 0)
    ğŸ“ Using event_ticket_id for eventTicketId: b8a1ef1f-5f53-4544-af7b-901756b9ba7d
    ğŸ” Looking up eventTicket: b8a1ef1f-5f53-4544-af7b-901756b9ba7d
    âœ… Found eventTicket: Existing Banquet Ticket bought by Lodge (price: 0)
    ğŸ“¦ Returning 4 processed tickets from registration_data
  âœ“ Found 4 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: 0198bbeb-1c3e-733f-adae-dbe0b87e633d-7196514b-d4b8-4fe0-93ac-deb4c205dd09 (Grand Proclamation Ceremony, qty: 1)
      âœ… Created ticket document
    ğŸ’¾ Saving ticket to import_tickets: 0198bbeb-1c3e-733f-adae-dbe0b87e633d-be94ef03-6647-48d5-97ea-f98c862e30e6 (Quarterly Communication, qty: 1)
      âœ… Created ticket document
    ğŸ’¾ Saving ticket to import_tickets: 0198bbeb-1c3e-733f-adae-dbe0b87e633d-b8a1ef1f-5f53-4544-af7b-901756b9ba7d (Existing Banquet Ticket bought by Lodge, qty: 1)
      âœ… Created ticket document
    ğŸ’¾ Saving ticket to import_tickets: 0198bbeb-b91c-723f-9cf9-689d1786375c-b8a1ef1f-5f53-4544-af7b-901756b9ba7d (Existing Banquet Ticket bought by Lodge, qty: 1)
      âœ… Created ticket document
    ğŸ“ Created registration reference: Grand Proclamation 2025 (2f4c440f-542c-4608-9974-186aef3eb8a1)
    âœ¨ Creating new contact with role 'attendee': Robert Drake
    ğŸ“‹ Registrations added: 1 items
      1. Grand Proclamation 2025 (2f4c440f-542c-4608-9974-186aef3eb8a1) - Conf: IND-248159RE
    âœ“ Processed unified contact: Robert Drake (roles: attendee)
    âš ï¸ Skipping contact with no email: Penny Drake
  ğŸ“ Updating registration with extracted references
    âœ… Updated registration with 4 ticket IDs (4 ObjectIds) and 2 attendee IDs (2 ObjectIds)
  âœ… Completed processing Square payment F6oCqaqnzPwfTGdhPYIZIBucz3HZY (production eligible)
  ğŸ”„ Syncing payment data to production...
    â†’ Syncing payment F6oCqaqnzPwfTGdhPYIZIBucz3HZY data to production...
      âœ“ Payment synced to production
      âœ“ Registration synced to production
      âœ“ Customer 3f7d99a3-e9fe-4b05-8523-f59c223d14c6 synced to production
      âœ“ Attendee 0198bbeb-1c3e-733f-adae-dbe0b87e633d synced to production
      âœ“ Attendee 0198bbeb-b91c-723f-9cf9-689d1786375c synced to production
      âœ“ Contact robert@noveix.com synced to production
      âœ“ Ticket 0198bbeb-1c3e-733f-adae-dbe0b87e633d-7196514b-d4b8-4fe0-93ac-deb4c205dd09 synced to production
      âœ“ Ticket 0198bbeb-1c3e-733f-adae-dbe0b87e633d-be94ef03-6647-48d5-97ea-f98c862e30e6 synced to production
      âœ“ Ticket 0198bbeb-1c3e-733f-adae-dbe0b87e633d-b8a1ef1f-5f53-4544-af7b-901756b9ba7d synced to production
      âœ“ Ticket 0198bbeb-b91c-723f-9cf9-689d1786375c-b8a1ef1f-5f53-4544-af7b-901756b9ba7d synced to production
    âœ… Payment F6oCqaqnzPwfTGdhPYIZIBucz3HZY complete data chain synced to production
  âœ… Payment data synced to production
Reached limit of 1 for Square

â”â”â” Processing DA-LODGETIX â”â”â”

ğŸ“ Processing charge: ch_3RYNqYKBASow5NsW17D1d6gl
  âœ… Importing successful charge - status: succeeded
  âœ“ Imported charge to import_payments with field transformation
  âœ“ Found registration: 222ddcc8-4f1a-4301-9e44-18a89770e1ed
  âœ“ Updated import_payments with registrationId: 222ddcc8-4f1a-4301-9e44-18a89770e1ed
  âœ“ Imported FULL registration to import_registrations with field transformation
  ğŸ“ Processing booking contact as customer
    Customer data created: Darren Allatt
    âœ“ Created new customer: Darren Allatt
    âœ“ Updated registration with customer reference: 8018d385-32d1-4ea8-a8aa-750bf293a22f
  âœ“ Found customer data for ticket ownership: Darren Allatt
    Extracting 1 attendees from registration_data
  âœ“ Found 1 attendee(s)
    Extracting 1 tickets from registration_data.tickets
    Total tickets after expansion: 1
    ğŸ” Looking up eventTicket: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    âœ… Found eventTicket: Grand Proclamation Ceremony (price: 20)
    ğŸ“¦ Returning 1 processed tickets from registration_data
  âœ“ Found 1 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: 01975903-bc26-7452-8d69-4438b9f7b70f-7196514b-d4b8-4fe0-93ac-deb4c205dd09 (Grand Proclamation Ceremony, qty: 1)
      âœ… Created ticket document
    ğŸ“ Created registration reference: Grand Proclamation 2025 (222ddcc8-4f1a-4301-9e44-18a89770e1ed)
    âœ¨ Creating new contact with role 'attendee': Darren Allatt
    ğŸ“‹ Registrations added: 1 items
      1. Grand Proclamation 2025 (222ddcc8-4f1a-4301-9e44-18a89770e1ed) - Conf: IND-834482AH
    âœ“ Processed unified contact: Darren Allatt (roles: attendee)
  ğŸ“ Updating registration with extracted references
    âœ… Updated registration with 1 ticket IDs (1 ObjectIds) and 1 attendee IDs (1 ObjectIds)
  âœ… Completed processing charge ch_3RYNqYKBASow5NsW17D1d6gl (production eligible)
  ğŸ”„ Syncing payment data to production...
    â†’ Syncing payment ch_3RYNqYKBASow5NsW17D1d6gl data to production...
      âœ“ Payment synced to production
      âœ“ Registration synced to production
      âœ“ Customer 8018d385-32d1-4ea8-a8aa-750bf293a22f synced to production
      âœ“ Attendee 01975903-bc26-7452-8d69-4438b9f7b70f synced to production
      âœ“ Contact darren@allatt.me synced to production
      âœ“ Ticket 01975903-bc26-7452-8d69-4438b9f7b70f-7196514b-d4b8-4fe0-93ac-deb4c205dd09 synced to production
    âœ… Payment ch_3RYNqYKBASow5NsW17D1d6gl complete data chain synced to production
  âœ… Payment data synced to production
Reached limit of 1 for DA-LODGETIX

â”â”â” Processing WS-LODGETIX â”â”â”

ğŸ“ Processing charge: ch_3RatsQHDfNBUEWUu0i6JkO6W
  âœ… Importing successful charge - status: succeeded
  âœ“ Imported charge to import_payments with field transformation
  âœ“ Found registration: 8a63ce42-9276-4254-b3cc-406d78cdbb16
  âœ“ Updated import_payments with registrationId: 8a63ce42-9276-4254-b3cc-406d78cdbb16
  âœ“ Imported FULL registration to import_registrations with field transformation
  ğŸ“ Processing booking contact as customer
    Customer data created: Amitava Sen
    âœ“ Created new customer: Amitava Sen
    âœ“ Updated registration with customer reference: b515a9e2-95e2-4532-91b6-d7401489a020
  âœ“ Found customer data for ticket ownership: Amitava Sen
    Extracting 1 attendees from registration_data
  âœ“ Found 1 attendee(s)
    Extracting 1 tickets from registration_data.tickets
    Total tickets after expansion: 1
    ğŸ” Looking up eventTicket: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    âœ… Found eventTicket: Grand Proclamation Ceremony (price: 20)
    ğŸ“¦ Returning 1 processed tickets from registration_data
  âœ“ Found 1 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: 01977cbf-62d1-709d-9b8d-847981b64f9b-7196514b-d4b8-4fe0-93ac-deb4c205dd09 (Grand Proclamation Ceremony, qty: 1)
      âœ… Created ticket document
    ğŸ“ Created registration reference: Grand Proclamation 2025 (8a63ce42-9276-4254-b3cc-406d78cdbb16)
    âœ¨ Creating new contact with role 'attendee': Amitava Sen
    ğŸ“‹ Registrations added: 1 items
      1. Grand Proclamation 2025 (8a63ce42-9276-4254-b3cc-406d78cdbb16) - Conf: IND-700495YH
    âœ“ Processed unified contact: Amitava Sen (roles: attendee)
  ğŸ“ Updating registration with extracted references
    âœ… Updated registration with 1 ticket IDs (1 ObjectIds) and 1 attendee IDs (1 ObjectIds)
  âœ… Completed processing charge ch_3RatsQHDfNBUEWUu0i6JkO6W (production eligible)
  ğŸ”„ Syncing payment data to production...
    â†’ Syncing payment ch_3RatsQHDfNBUEWUu0i6JkO6W data to production...
      âœ“ Payment synced to production
      âœ“ Registration synced to production
      âœ“ Customer b515a9e2-95e2-4532-91b6-d7401489a020 synced to production
      âœ“ Attendee 01977cbf-62d1-709d-9b8d-847981b64f9b synced to production
      âœ“ Contact amit@sen.id.au synced to production
      âœ“ Ticket 01977cbf-62d1-709d-9b8d-847981b64f9b-7196514b-d4b8-4fe0-93ac-deb4c205dd09 synced to production
    âœ… Payment ch_3RatsQHDfNBUEWUu0i6JkO6W complete data chain synced to production
  âœ… Payment data synced to production
Reached limit of 1 for WS-LODGETIX

â”â”â” Processing WS-LODGETICKETS â”â”â”

ğŸ“ Processing charge: ch_3RbJfOCari1bgsWq0CxPr7NI
  âœ… Importing successful charge - status: succeeded
  âœ“ Imported charge to import_payments with field transformation
  âœ“ Found registration: 533f4153-ab85-4552-a372-2d71fc42e546
  âœ“ Updated import_payments with registrationId: 533f4153-ab85-4552-a372-2d71fc42e546
  âœ“ Imported FULL registration to import_registrations with field transformation
  ğŸ“ Processing booking contact as customer
    Customer data created: Marcelo III Caguioa
    âœ“ Created new customer: Marcelo III Caguioa
    âœ“ Updated registration with customer reference: 2bc2c1db-e498-4142-81af-4d2ff9a1f0c0
  âœ“ Found customer data for ticket ownership: Marcelo III Caguioa
    Extracting 1 attendees from registration_data
  âœ“ Found 1 attendee(s)
    Extracting 1 tickets from registration_data.tickets
    Total tickets after expansion: 1
    ğŸ” Looking up eventTicket: fd12d7f0-f346-49bf-b1eb-0682ad226216
    âœ… Found eventTicket: Proclamation Banquet - Best Available (price: 115)
    ğŸ“¦ Returning 1 processed tickets from registration_data
  âœ“ Found 1 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: 019781d7-a8f9-723f-8b78-b449d5467f8d-fd12d7f0-f346-49bf-b1eb-0682ad226216 (Proclamation Banquet - Best Available, qty: 1)
      âœ… Created ticket document
    ğŸ“ Created registration reference: Grand Proclamation 2025 (533f4153-ab85-4552-a372-2d71fc42e546)
    âœ¨ Creating new contact with role 'attendee': Marcelo III Caguioa
    ğŸ“‹ Registrations added: 1 items
      1. Grand Proclamation 2025 (533f4153-ab85-4552-a372-2d71fc42e546) - Conf: IND-777516CY
    âœ“ Processed unified contact: Marcelo III Caguioa (roles: attendee)
  ğŸ“ Updating registration with extracted references
    âœ… Updated registration with 1 ticket IDs (1 ObjectIds) and 1 attendee IDs (1 ObjectIds)
  âœ… Completed processing charge ch_3RbJfOCari1bgsWq0CxPr7NI (production eligible)
  ğŸ”„ Syncing payment data to production...
    â†’ Syncing payment ch_3RbJfOCari1bgsWq0CxPr7NI data to production...
      âœ“ Payment synced to production
      âœ“ Registration synced to production
      âœ“ Customer 2bc2c1db-e498-4142-81af-4d2ff9a1f0c0 synced to production
      âœ“ Attendee 019781d7-a8f9-723f-8b78-b449d5467f8d synced to production
      âœ“ Contact marcelocaguioa@yahoo.com synced to production
      âœ“ Ticket 019781d7-a8f9-723f-8b78-b449d5467f8d-fd12d7f0-f346-49bf-b1eb-0682ad226216 synced to production
    âœ… Payment ch_3RbJfOCari1bgsWq0CxPr7NI complete data chain synced to production
  âœ… Payment data synced to production
Reached limit of 1 for WS-LODGETICKETS

âœ… All payments processed with immediate production sync
   Each payment's complete data chain was synced to production before processing the next payment
   This prevents orphaned tickets and ensures all relationships are properly maintained

ğŸ” Starting Error Verification...
Checking error documents against test database...


ğŸ“Š VERIFICATION RESULTS:
Error Payments - Found: 0, Not Found: 0
Error Registrations - Found: 0, Not Found: 0
Orphaned Registrations - Found: 0, Not Found: 0
âœ… Error verification completed


ğŸ›’ Processing Orders from Registrations...
âœ… Orders created: 0
â­ï¸ Orders skipped: 4
âš ï¸ Order processing errors: 4

=== SYNC COMPLETE ===
âœ… Processed: 4
â­ï¸ Skipped: 0
âŒ Errors: 0
ğŸ‘¥ Unique contacts: 4
ğŸ“Š Total: 4
