=== ENHANCED PAYMENT SYNC LOG ===
Started at: 2025-08-20T03:39:35.873Z
Processing Square with orders/customers and contacts

✓ Supabase client initialized
✓ Square provider initialized (REQUIRED)
✓ DA-LODGETIX initialized
✓ WS-LODGETIX initialized
✓ WS-LODGETICKETS initialized

Initialized 4 payment provider(s)
✓ Connected to MongoDB:
  Cluster: LodgeTix-migration-test-1
  Database: lodgetix
  URI: mongodb+srv:****@lodgetix-migration-test.wydwfu6.mongodb.net/lodgetix?retryWrites=true&w=majority&appName=LodgeTix-migration-test-1

=== STARTING ENHANCED PAYMENT SYNC ===
Processing workflow:
1. Import payment to import_payments (with field transformation)
2. Fetch order/customer for Square payments
3. Find registration in Supabase
4. Update with charge ID for Stripe
5. Import to import_registrations (with field transformation)
6. Import attendees to import_attendees
7. Import tickets to import_tickets
8. Import contacts to import_contacts with deduplication
9. Process booking contact as customer with registration metadata
9. Selective sync to production collections based on field comparison


━━━ Processing Square ━━━

Fetching Square payments since 2025-08-19T12:14:33.806Z (INCREMENTAL)...
  Fetched payment 1 (cursor: none)

📝 Processing Square payment: pW92KlFiAD3lCPPrCYaSJyvjnSVZY
  ✅ Importing completed payment - status: COMPLETED
  🛒 Fetching order: PelrMCEeQG06gacOlmcfbRxcENLZY
    ✓ Order fetched
  👤 Fetching customer: WFNMMBZ1X84WQG0KQS6XR4EE4M
    ✓ Customer fetched
  ✓ Imported to import_payments with field transformation
  ✓ Found registration: b31672d1-cd02-489d-aebf-2b5b093a26d8
  ✓ Updated import_payments with registrationId: b31672d1-cd02-489d-aebf-2b5b093a26d8
  ✓ Imported FULL registration to import_registrations with field transformation
  📝 Processing booking contact as customer
    Customer data created: Raymund Arnold S Alberto
    ✓ Created new customer: Raymund Arnold S Alberto
    ✓ Updated registration with customer reference: c0c7f7dc-1549-49e3-aae1-abc2d9e3d838
  ✓ Found customer data for ticket ownership: Raymund Arnold S Alberto
    Extracting 1 attendees from registration_data
    🔍 Looking up grand lodge: 0ce8e42a-e50f-46f8-bcee-c5e9eb97086b
    ✓ Found grand lodge name: Most Worshipful Grand Lodge of Philippines
  ✓ Found 1 attendee(s)
    Extracting 2 tickets from registration_data.selectedTickets
    Total tickets after expansion: 2
    📝 Using event_ticket_id for eventTicketId: d586ecc1-e410-4ef3-a59c-4a53a866bc33
    🔍 Looking up eventTicket: d586ecc1-e410-4ef3-a59c-4a53a866bc33
    ✅ Found eventTicket: Meet & Greet Cocktail Party (price: 70)
    📝 Using event_ticket_id for eventTicketId: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    🔍 Looking up eventTicket: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    ✅ Found eventTicket: Grand Proclamation Ceremony (price: 20)
    📦 Returning 2 processed tickets from registration_data
  ✓ Found 2 ticket(s) in registration
    💾 Saving ticket to import_tickets: 0198c241-2729-7257-abf2-5127a6d70c43-d586ecc1-e410-4ef3-a59c-4a53a866bc33 (Meet & Greet Cocktail Party, qty: 1)
      ✅ Created ticket document
    💾 Saving ticket to import_tickets: 0198c241-2729-7257-abf2-5127a6d70c43-7196514b-d4b8-4fe0-93ac-deb4c205dd09 (Grand Proclamation Ceremony, qty: 1)
      ✅ Created ticket document
    📝 Created registration reference: Grand Proclamation 2025 (b31672d1-cd02-489d-aebf-2b5b093a26d8)
    ✨ Creating new contact with role 'attendee': Raymund Arnold S Alberto
    📋 Registrations added: 1 items
      1. Grand Proclamation 2025 (b31672d1-cd02-489d-aebf-2b5b093a26d8) - Conf: IND-441855WM
    ✓ Processed unified contact: Raymund Arnold S Alberto (roles: attendee)
  📝 Updating registration with extracted references
    ✅ Updated registration with 2 ticket IDs (2 ObjectIds) and 1 attendee IDs (1 ObjectIds)
  ✅ Completed processing Square payment pW92KlFiAD3lCPPrCYaSJyvjnSVZY (production eligible)
  🔄 Syncing payment data to production...
    → Syncing payment pW92KlFiAD3lCPPrCYaSJyvjnSVZY data to production...
      ✓ Payment synced to production
      ✓ Registration synced to production
      ✓ Customer c0c7f7dc-1549-49e3-aae1-abc2d9e3d838 synced to production
      ✓ Attendee 0198c241-2729-7257-abf2-5127a6d70c43 synced to production
      ✓ Contact rasaglobe@gmail.com synced to production
      ✓ Ticket 0198c241-2729-7257-abf2-5127a6d70c43-d586ecc1-e410-4ef3-a59c-4a53a866bc33 synced to production
      ✓ Ticket 0198c241-2729-7257-abf2-5127a6d70c43-7196514b-d4b8-4fe0-93ac-deb4c205dd09 synced to production
    ✅ Payment pW92KlFiAD3lCPPrCYaSJyvjnSVZY complete data chain synced to production
  ✅ Payment data synced to production
  No cursor found, completed all Square payments
✓ Processed 1 Square payments (total fetched: 1)

━━━ Processing DA-LODGETIX ━━━

Fetching Stripe charges since 2025-08-19T12:14:33.806Z (INCREMENTAL)...

━━━ Processing WS-LODGETIX ━━━

Fetching Stripe charges since 2025-08-19T12:14:33.806Z (INCREMENTAL)...

━━━ Processing WS-LODGETICKETS ━━━

Fetching Stripe charges since 2025-08-19T12:14:33.806Z (INCREMENTAL)...

✅ All payments processed with immediate production sync
   Each payment's complete data chain was synced to production before processing the next payment
   This prevents orphaned tickets and ensures all relationships are properly maintained

🔍 Starting Error Verification...
Checking error documents against test database...


📊 VERIFICATION RESULTS:
Error Payments - Found: 0, Not Found: 12
Error Registrations - Found: 0, Not Found: 0
Orphaned Registrations - Found: 0, Not Found: 0

📈 Overall: 0.00% of error documents exist in test DB
⚠️  Low found rate indicates genuine sync failures
✅ Error verification completed


🛒 Processing Orders from Registrations...
✅ Orders created: 0
⏭️ Orders skipped: 306
⚠️ Order processing errors: 306

=== SYNC COMPLETE ===
✅ Processed: 1
⏭️ Skipped: 0
❌ Errors: 0
👥 Unique contacts: 1
📊 Total: 1
