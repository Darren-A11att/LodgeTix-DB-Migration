=== ENHANCED PAYMENT SYNC LOG ===
Started at: 2025-08-25T12:58:28.468Z
Processing Square with orders/customers and contacts

âœ“ Supabase client initialized
âœ“ Square provider initialized (REQUIRED)
âœ“ DA-LODGETIX initialized
âœ“ WS-LODGETIX initialized
âœ“ WS-LODGETICKETS initialized

Initialized 4 payment provider(s)
âœ“ Connected to MongoDB:
  Cluster: LodgeTix-migration-test-1
  Database: lodgetix
  URI: mongodb+srv:****@lodgetix-migration-test.wydwfu6.mongodb.net/lodgetix?retryWrites=true&w=majority&appName=LodgeTix-migration-test-1

=== STARTING ENHANCED PAYMENT SYNC ===
Processing workflow:
1. Import payment to import_payments (with field transformation)
2. Fetch order/customer for Square payments
3. Find registration in Supabase
4. Update with charge ID for Stripe
5. Import to import_registrations (with field transformation)
6. Import attendees to import_attendees
7. Import tickets to import_tickets
8. Import contacts to import_contacts with deduplication
9. Process booking contact as customer with registration metadata
9. Selective sync to production collections based on field comparison


â”â”â” Processing Square â”â”â”

Fetching Square payments since 2025-08-25T10:41:58.841Z (INCREMENTAL)...
  Fetched payment 1 (cursor: none)

ğŸ“ Processing Square payment: PBl8UqO1NAwkHuOO9MsfkhV68p5YY
  âœ… Importing completed payment - status: COMPLETED
  ğŸ›’ Fetching order: hXVV1pqoBypWkRUVznmUlesD39MZY
    âœ“ Order fetched
  ğŸ‘¤ Fetching customer: ZYQPYZPEYWVA7NXMXK1D8HFCDW
    âœ“ Customer fetched
  âœ“ Imported to import_payments with field transformation
  âœ“ Found registration: ae82b9b1-7b2b-4175-a4b0-b62c217b5ff1
  âœ“ Updated import_payments with registrationId: ae82b9b1-7b2b-4175-a4b0-b62c217b5ff1
  âœ“ Imported FULL registration to import_registrations with field transformation
  ğŸ“ Processing booking contact as customer
    Customer data created: Felipe Santos Silva Fonseca
    âœ“ Created new customer: Felipe Santos Silva Fonseca
    âœ“ Updated registration with customer reference: 243e4a44-d3ae-41fd-8c60-45ed9102d48c
  âœ“ Found customer data for ticket ownership: Felipe Santos Silva Fonseca
    Extracting 1 attendees from registration_data
    ğŸ” Looking up grand lodge: 3e893fa6-2cc2-448c-be9c-e3858cc90e11
    âœ“ Found grand lodge name: United Grand Lodge of New South Wales & Australian Capital Territory
  âœ“ Found 1 attendee(s)
    Extracting 2 tickets from registration_data.selectedTickets
    Total tickets after expansion: 2
    ğŸ“ Using event_ticket_id for eventTicketId: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    ğŸ” Looking up eventTicket: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    âœ… Found eventTicket: Grand Proclamation Ceremony (price: 20)
    ğŸ“ Using event_ticket_id for eventTicketId: be94ef03-6647-48d5-97ea-f98c862e30e6
    ğŸ” Looking up eventTicket: be94ef03-6647-48d5-97ea-f98c862e30e6
    âœ… Found eventTicket: Quarterly Communication (price: 0)
    ğŸ“¦ Returning 2 processed tickets from registration_data
  âœ“ Found 2 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: 0198deb1-5210-77a4-be22-348ce38634cf-7196514b-d4b8-4fe0-93ac-deb4c205dd09 (Grand Proclamation Ceremony, qty: 1)
      âœ… Created ticket document
    ğŸ’¾ Saving ticket to import_tickets: 0198deb1-5210-77a4-be22-348ce38634cf-be94ef03-6647-48d5-97ea-f98c862e30e6 (Quarterly Communication, qty: 1)
      âœ… Created ticket document
    ğŸ“ Created registration reference: Grand Proclamation 2025 (ae82b9b1-7b2b-4175-a4b0-b62c217b5ff1)
    âœ¨ Creating new contact with role 'attendee': Felipe Fonseca
    ğŸ“‹ Registrations added: 1 items
      1. Grand Proclamation 2025 (ae82b9b1-7b2b-4175-a4b0-b62c217b5ff1) - Conf: IND-171909GW
    âœ“ Processed unified contact: Felipe Fonseca (roles: attendee)
  ğŸ“ Updating registration with extracted references
    âœ… Updated registration with 2 ticket IDs (2 ObjectIds) and 1 attendee IDs (1 ObjectIds)
  âœ… Completed processing Square payment PBl8UqO1NAwkHuOO9MsfkhV68p5YY (production eligible)
  ğŸ”„ Syncing payment data to production...
    â†’ Syncing payment PBl8UqO1NAwkHuOO9MsfkhV68p5YY data to production...
      âœ“ Payment synced to production
      âœ“ Registration synced to production
      âœ“ Customer 243e4a44-d3ae-41fd-8c60-45ed9102d48c synced to production
      âœ“ Attendee 0198deb1-5210-77a4-be22-348ce38634cf synced to production
      âœ“ Contact felipessfonseca@gmail.com synced to production
      âœ“ Ticket 0198deb1-5210-77a4-be22-348ce38634cf-7196514b-d4b8-4fe0-93ac-deb4c205dd09 synced to production
      âœ“ Ticket 0198deb1-5210-77a4-be22-348ce38634cf-be94ef03-6647-48d5-97ea-f98c862e30e6 synced to production
    âœ… Payment PBl8UqO1NAwkHuOO9MsfkhV68p5YY complete data chain synced to production
  âœ… Payment data synced to production
  Got cursor for next payment
  Fetched payment 2 (cursor: provided)

ğŸ“ Processing Square payment: 9eAa7ppZx5ZDSs3UkWr6vVxNWcAZY
  âœ… Importing completed payment - status: COMPLETED
  ğŸ›’ Fetching order: RBqn9g0T30v0BWZniavexRoOSj6YY
    âœ“ Order fetched
  ğŸ‘¤ Fetching customer: 98VG6X7AZGC03KXBQT0A950K7C
    âœ“ Customer fetched
  âœ“ Imported to import_payments with field transformation
  âœ“ Found registration: 4917e184-766f-4ed9-89a7-92dae2b1fe7d
  âœ“ Updated import_payments with registrationId: 4917e184-766f-4ed9-89a7-92dae2b1fe7d
  âœ“ Imported FULL registration to import_registrations with field transformation
  ğŸ“ Processing booking contact as customer
    Customer data created: Allan Wojcik da Silva
    âœ“ Created new customer: Allan Wojcik da Silva
    âœ“ Updated registration with customer reference: 8cda41a9-cf25-4fef-87c1-d2d1199fadf5
  âœ“ Found customer data for ticket ownership: Allan Wojcik da Silva
    Extracting 1 attendees from registration_data
    ğŸ” Looking up grand lodge: 3e893fa6-2cc2-448c-be9c-e3858cc90e11
    âœ“ Found grand lodge name: United Grand Lodge of New South Wales & Australian Capital Territory
  âœ“ Found 1 attendee(s)
    Extracting 2 tickets from registration_data.selectedTickets
    Total tickets after expansion: 2
    ğŸ“ Using event_ticket_id for eventTicketId: be94ef03-6647-48d5-97ea-f98c862e30e6
    ğŸ” Looking up eventTicket: be94ef03-6647-48d5-97ea-f98c862e30e6
    âœ… Found eventTicket: Quarterly Communication (price: 0)
    ğŸ“ Using event_ticket_id for eventTicketId: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    ğŸ” Looking up eventTicket: 7196514b-d4b8-4fe0-93ac-deb4c205dd09
    âœ… Found eventTicket: Grand Proclamation Ceremony (price: 20)
    ğŸ“¦ Returning 2 processed tickets from registration_data
  âœ“ Found 2 ticket(s) in registration
    ğŸ’¾ Saving ticket to import_tickets: 0198e0cd-b708-7498-803e-b9e97df0e158-be94ef03-6647-48d5-97ea-f98c862e30e6 (Quarterly Communication, qty: 1)
      âœ… Created ticket document
    ğŸ’¾ Saving ticket to import_tickets: 0198e0cd-b708-7498-803e-b9e97df0e158-7196514b-d4b8-4fe0-93ac-deb4c205dd09 (Grand Proclamation Ceremony, qty: 1)
      âœ… Created ticket document
    ğŸ“ Created registration reference: Grand Proclamation 2025 (4917e184-766f-4ed9-89a7-92dae2b1fe7d)
    âœ¨ Creating new contact with role 'attendee': Allan Wojcik da Silva
    ğŸ“‹ Registrations added: 1 items
      1. Grand Proclamation 2025 (4917e184-766f-4ed9-89a7-92dae2b1fe7d) - Conf: IND-856458TX
    âœ“ Processed unified contact: Allan Wojcik da Silva (roles: attendee)
  ğŸ“ Updating registration with extracted references
    âœ… Updated registration with 2 ticket IDs (2 ObjectIds) and 1 attendee IDs (1 ObjectIds)
  âœ… Completed processing Square payment 9eAa7ppZx5ZDSs3UkWr6vVxNWcAZY (production eligible)
  ğŸ”„ Syncing payment data to production...
    â†’ Syncing payment 9eAa7ppZx5ZDSs3UkWr6vVxNWcAZY data to production...
      âœ“ Payment synced to production
      âœ“ Registration synced to production
      âœ“ Customer 8cda41a9-cf25-4fef-87c1-d2d1199fadf5 synced to production
      âœ“ Attendee 0198e0cd-b708-7498-803e-b9e97df0e158 synced to production
      âœ“ Contact allanwsilva@gmail.com synced to production
      âœ“ Ticket 0198e0cd-b708-7498-803e-b9e97df0e158-be94ef03-6647-48d5-97ea-f98c862e30e6 synced to production
      âœ“ Ticket 0198e0cd-b708-7498-803e-b9e97df0e158-7196514b-d4b8-4fe0-93ac-deb4c205dd09 synced to production
    âœ… Payment 9eAa7ppZx5ZDSs3UkWr6vVxNWcAZY complete data chain synced to production
  âœ… Payment data synced to production
  No cursor found, completed all Square payments
âœ“ Processed 2 Square payments (total fetched: 2)

â”â”â” Processing DA-LODGETIX â”â”â”

Fetching Stripe charges since 2025-08-25T10:41:58.841Z (INCREMENTAL)...

â”â”â” Processing WS-LODGETIX â”â”â”

Fetching Stripe charges since 2025-08-25T10:41:58.841Z (INCREMENTAL)...

â”â”â” Processing WS-LODGETICKETS â”â”â”

Fetching Stripe charges since 2025-08-25T10:41:58.841Z (INCREMENTAL)...

âœ… All payments processed with immediate production sync
   Each payment's complete data chain was synced to production before processing the next payment
   This prevents orphaned tickets and ensures all relationships are properly maintained

ğŸ” Starting Error Verification...
Checking error documents against test database...


ğŸ“Š VERIFICATION RESULTS:
Error Payments - Found: 0, Not Found: 12
Error Registrations - Found: 0, Not Found: 0
Orphaned Registrations - Found: 0, Not Found: 0

ğŸ“ˆ Overall: 0.00% of error documents exist in test DB
âš ï¸  Low found rate indicates genuine sync failures
âœ… Error verification completed


ğŸ›’ Processing Orders from Registrations...
âœ… Orders created: 2
â­ï¸ Orders skipped: 317

ğŸ“‹ Skip Reasons:
   Order already exists for this registration: 317 orders

=== SYNC COMPLETE ===
âœ… Processed: 2
â­ï¸ Skipped: 0
âŒ Errors: 0
ğŸ‘¥ Unique contacts: 2
ğŸ“Š Total: 2
